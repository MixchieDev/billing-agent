generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  name              String?
  email             String             @unique
  emailVerified     DateTime?
  password          String?
  image             String?
  role              UserRole           @default(VIEWER)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  accounts          Account[]
  auditLogs         AuditLog[]
  approvals         Invoice[]          @relation("ApprovedBy")
  rejections        Invoice[]          @relation("RejectedBy")
  voids             Invoice[]          @relation("VoidedBy")
  notifications     Notification[]
  schedulesApproved ScheduledBilling[] @relation("ScheduleApprovedBy")
  schedulesCreated  ScheduledBilling[] @relation("ScheduleCreatedBy")
  schedulesRejected ScheduledBilling[] @relation("ScheduleRejectedBy")
  sessions          Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Company {
  id                String             @id @default(cuid())
  code              String             @unique
  name              String
  address           String?
  contactNumber     String?
  tin               String?
  bankName          String?
  bankAccountName   String?
  bankAccountNo     String?
  formReference     String?
  logoPath          String?
  invoicePrefix     String?
  nextInvoiceNo     Int                @default(1)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  contractPrefix    String?
  nextContractNo    Int                @default(1)
  contracts         Contract[]
  invoices          Invoice[]
  template          InvoiceTemplate?
  partners          Partner[]
  scheduledBillings ScheduledBilling[] @relation("ScheduledBillingEntity")
  signatories       Signatory[]
}

model Signatory {
  id        String   @id @default(cuid())
  companyId String
  role      String
  name      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, role, isDefault])
}

model InvoiceTemplate {
  id             String   @id @default(cuid())
  companyId      String   @unique
  primaryColor   String   @default("#2563eb")
  secondaryColor String   @default("#1e40af")
  footerBgColor  String   @default("#dbeafe")
  logoPath       String?
  invoiceTitle   String   @default("Invoice")
  footerText     String   @default("Powered by: YAHSHUA")
  showDisclaimer Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  notes          String?
  company        Company  @relation(fields: [companyId], references: [id])
}

model Partner {
  id              String         @id @default(cuid())
  code            String         @unique
  name            String
  invoiceTo       String?
  attention       String?
  address         String?
  email           String?
  billingModel    BillingModel   @default(DIRECT)
  companyId       String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  emailTemplateId String?
  emails          String?
  contracts       Contract[]
  invoices        Invoice[]
  company         Company        @relation(fields: [companyId], references: [id])
  emailTemplate   EmailTemplate? @relation(fields: [emailTemplateId], references: [id])
}

model EmailTemplate {
  id            String        @id @default(cuid())
  name          String        @unique
  subject       String
  greeting      String
  body          String
  closing       String
  isDefault     Boolean       @default(false)
  templateType  String        @default("BILLING") // "BILLING" | "FOLLOW_UP"
  followUpLevel Int?          // 1, 2, or 3 for follow-up templates
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  partners      Partner[]
  followUpLogs  FollowUpLog[]
}

model Contract {
  id                String             @id @default(cuid())
  customerId        String?
  companyName       String
  productType       ProductType
  revenueModel      String?
  partnerId         String?
  monthlyFee        Decimal            @db.Decimal(15, 2)
  paymentPlan       String?
  contractStart     DateTime?
  nextDueDate       DateTime?
  lastPaymentDate   DateTime?
  daysOverdue       Int                @default(0)
  status            ContractStatus     @default(NOT_STARTED)
  contactPerson     String?
  email             String?
  tin               String?
  mobile            String?
  industry          String?
  amountDue         Decimal?           @db.Decimal(15, 2)
  vatType           VatType            @default(VAT)
  vatAmount         Decimal?           @db.Decimal(15, 2)
  totalWithVat      Decimal?           @db.Decimal(15, 2)
  withholdingTax    Decimal?           @db.Decimal(15, 2)
  netReceivable     Decimal?           @db.Decimal(15, 2)
  clientSince       DateTime?
  lifetimeValue     Decimal?           @db.Decimal(15, 2)
  renewalRisk       String?
  remarks           String?
  billingAmount     Decimal?           @db.Decimal(15, 2)
  billingType       BillingType        @default(RECURRING)
  billingEntityId   String
  employeeCount     Int?
  ratePerEmployee   Decimal?           @db.Decimal(10, 2)
  autoSendEnabled   Boolean            @default(true)
  contractEndDate   DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  sheetRowIndex     Int?
  autoApprove       Boolean            @default(false)
  billingDayOfMonth Int?
  withholdingRate   Decimal?           @db.Decimal(5, 4)
  emails            String?
  address           String?
  customerNumber    String?            @unique
  billingEntity     Company            @relation(fields: [billingEntityId], references: [id])
  partner           Partner?           @relation(fields: [partnerId], references: [id])
  lineItems         InvoiceLineItem[]
  scheduledBillings ScheduledBilling[]
  invoices          Invoice[]          @relation("ContractToInvoice")

  @@index([status])
  @@index([billingEntityId])
  @@index([partnerId])
  @@index([nextDueDate])
  @@index([createdAt])
  @@index([status, nextDueDate])
}

model Invoice {
  id                    String                 @id @default(cuid())
  invoiceNo             String?                @unique
  billingNo             String?
  companyId             String
  customerName          String
  attention             String?
  customerAddress       String?
  customerEmail         String?
  customerTin           String?
  statementDate         DateTime
  dueDate               DateTime
  periodStart           DateTime?
  periodEnd             DateTime?
  periodDescription     String?
  serviceFee            Decimal                @db.Decimal(15, 2)
  vatAmount             Decimal                @default(0) @db.Decimal(15, 2)
  grossAmount           Decimal                @db.Decimal(15, 2)
  withholdingTax        Decimal                @default(0) @db.Decimal(15, 2)
  netAmount             Decimal                @db.Decimal(15, 2)
  vatType               VatType                @default(VAT)
  hasWithholding        Boolean                @default(false)
  withholdingCode       String?
  billingFrequency      BillingFrequency       @default(MONTHLY)
  monthlyFee            Decimal?               @db.Decimal(15, 2)
  status                InvoiceStatus          @default(PENDING)
  approvedById          String?
  approvedAt            DateTime?
  rejectedById          String?
  rejectedAt            DateTime?
  rejectionReason       String?
  rescheduleDate        DateTime?
  pdfPath               String?
  csvPath               String?
  emailStatus           EmailStatus            @default(NOT_SENT)
  emailSentAt           DateTime?
  emailError            String?
  paidAt                DateTime?
  paidAmount            Decimal?               @db.Decimal(15, 2)
  paymentMethod         String?
  paymentReference      String?
  billingModel          BillingModel           @default(DIRECT)
  isConsolidated        Boolean                @default(false)
  remarks               String?
  preparedBy            String?
  reviewedBy            String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  partnerId             String?
  withholdingRate       Decimal?               @db.Decimal(5, 4)
  customerEmails        String?
  voidReason            String?
  voidedAt              DateTime?
  voidedById            String?
  followUpEnabled       Boolean                @default(true)
  followUpCount         Int                    @default(0)
  lastFollowUpAt        DateTime?
  lastFollowUpLevel     Int                    @default(0)
  emailLogs             EmailLog[]
  followUpLogs          FollowUpLog[]
  hitpayPaymentRequests HitpayPaymentRequest[]
  approvedBy            User?                  @relation("ApprovedBy", fields: [approvedById], references: [id])
  company               Company                @relation(fields: [companyId], references: [id])
  partner               Partner?               @relation(fields: [partnerId], references: [id])
  rejectedBy            User?                  @relation("RejectedBy", fields: [rejectedById], references: [id])
  voidedBy              User?                  @relation("VoidedBy", fields: [voidedById], references: [id])
  attachments           InvoiceAttachment[]
  lineItems             InvoiceLineItem[]
  scheduledBillingRuns  ScheduledBillingRun[]
  contracts             Contract[]             @relation("ContractToInvoice")

  @@index([status])
  @@index([companyId])
  @@index([partnerId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([paidAt])
}

model InvoiceLineItem {
  id             String    @id @default(cuid())
  invoiceId      String
  contractId     String?
  date           DateTime?
  reference      String?
  description    String
  poNumber       String?
  quantity       Int       @default(1)
  unitPrice      Decimal   @db.Decimal(15, 2)
  serviceFee     Decimal   @db.Decimal(15, 2)
  vatAmount      Decimal   @default(0) @db.Decimal(15, 2)
  withholdingTax Decimal   @default(0) @db.Decimal(15, 2)
  amount         Decimal   @db.Decimal(15, 2)
  endClientName  String?
  employeeCount  Int?
  sortOrder      Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  contract       Contract? @relation(fields: [contractId], references: [id])
  invoice        Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([contractId])
}

model InvoiceAttachment {
  id         String   @id @default(cuid())
  invoiceId  String
  filename   String
  mimeType   String
  size       Int
  data       Bytes
  uploadedAt DateTime @default(now())
  uploadedBy String?
  invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model RcbcEndClient {
  id              String   @id @default(cuid())
  name            String
  employeeCount   Int
  month           DateTime
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  ratePerEmployee Decimal  @default(0) @db.Decimal(10, 2)

  @@unique([name, month])
}

model EmailLog {
  id         String      @id @default(cuid())
  invoiceId  String
  toEmail    String
  subject    String
  status     EmailStatus
  sendGridId String?
  error      String?
  sentAt     DateTime?
  createdAt  DateTime    @default(now())
  invoice    Invoice     @relation(fields: [invoiceId], references: [id])
}

model FollowUpLog {
  id         String         @id @default(cuid())
  invoiceId  String
  level      Int            // 1, 2, or 3 (escalation level)
  sentAt     DateTime       @default(now())
  toEmail    String
  subject    String
  status     EmailStatus    @default(NOT_SENT)
  templateId String?
  messageId  String?
  error      String?
  createdAt  DateTime       @default(now())
  invoice    Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  template   EmailTemplate? @relation(fields: [templateId], references: [id])

  @@index([invoiceId])
  @@index([sentAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([entityId, entityType])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ScheduledJob {
  id        String    @id @default(cuid())
  name      String
  cronExpr  String
  lastRun   DateTime?
  nextRun   DateTime?
  isEnabled Boolean   @default(true)
  status    JobStatus @default(IDLE)
  lastError String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model JobRun {
  id             String    @id @default(cuid())
  jobName        String
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  status         JobStatus
  itemsProcessed Int       @default(0)
  errors         Json?
  createdAt      DateTime  @default(now())
}

model Settings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  category    String   @default("general")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Notification {
  id         String           @id @default(cuid())
  userId     String?
  type       NotificationType
  title      String
  message    String
  link       String?
  entityType String?
  entityId   String?
  isRead     Boolean          @default(false)
  createdAt  DateTime         @default(now())
  user       User?            @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([createdAt])
}

model ScheduledBilling {
  id                  String                @id @default(cuid())
  contractId          String
  billingEntityId     String
  billingAmount       Decimal               @db.Decimal(15, 2)
  vatType             VatType               @default(VAT)
  hasWithholding      Boolean               @default(false)
  description         String?
  frequency           BillingFrequency      @default(MONTHLY)
  billingDayOfMonth   Int
  startDate           DateTime              @default(now())
  endDate             DateTime?
  nextBillingDate     DateTime?
  autoApprove         Boolean               @default(false)
  autoSendEnabled     Boolean               @default(true)
  status              ScheduleStatus        @default(PENDING)
  remarks             String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  withholdingRate     Decimal?              @db.Decimal(5, 4)
  approvedAt          DateTime?
  approvedById        String?
  createdById         String?
  customIntervalUnit  IntervalUnit?
  customIntervalValue Int?
  rejectedAt          DateTime?
  rejectedById        String?
  rejectionReason     String?
  dueDayOfMonth       Int?
  approvedBy          User?                 @relation("ScheduleApprovedBy", fields: [approvedById], references: [id])
  billingEntity       Company               @relation("ScheduledBillingEntity", fields: [billingEntityId], references: [id])
  contract            Contract              @relation(fields: [contractId], references: [id])
  createdBy           User?                 @relation("ScheduleCreatedBy", fields: [createdById], references: [id])
  rejectedBy          User?                 @relation("ScheduleRejectedBy", fields: [rejectedById], references: [id])
  runs                ScheduledBillingRun[]

  @@index([billingDayOfMonth])
  @@index([status, nextBillingDate])
}

model ScheduledBillingRun {
  id                 String           @id @default(cuid())
  scheduledBillingId String
  invoiceId          String?
  runDate            DateTime         @default(now())
  status             RunStatus        @default(PENDING)
  errorMessage       String?
  createdAt          DateTime         @default(now())
  invoice            Invoice?         @relation(fields: [invoiceId], references: [id])
  scheduledBilling   ScheduledBilling @relation(fields: [scheduledBillingId], references: [id])

  @@index([scheduledBillingId])
  @@index([runDate])
}

model HitpayPaymentRequest {
  id               String              @id @default(cuid())
  invoiceId        String
  hitpayRequestId  String              @unique
  checkoutUrl      String?
  amount           Decimal             @db.Decimal(15, 2)
  currency         String              @default("PHP")
  status           HitpayPaymentStatus @default(PENDING)
  paidAt           DateTime?
  paymentMethod    String?
  paymentReference String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  invoice          Invoice             @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([hitpayRequestId])
}

enum UserRole {
  ADMIN
  APPROVER
  VIEWER
}

enum BillingModel {
  DIRECT
  GLOBE_INNOVE
  RCBC_CONSOLIDATED
}

enum ProductType {
  ACCOUNTING
  PAYROLL
  COMPLIANCE
  HR
}

enum ContractStatus {
  ACTIVE
  INACTIVE
  STOPPED
  NOT_STARTED
}

enum VatType {
  VAT
  NON_VAT
}

enum BillingType {
  RECURRING
  ONE_TIME
}

enum BillingFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
  CUSTOM
}

enum IntervalUnit {
  DAYS
  MONTHS
}

enum InvoiceStatus {
  PENDING
  APPROVED
  REJECTED
  SENT
  PAID
  CANCELLED
  VOID
}

enum EmailStatus {
  NOT_SENT
  QUEUED
  SENT
  FAILED
}

enum JobStatus {
  IDLE
  RUNNING
  COMPLETED
  FAILED
}

enum NotificationType {
  INVOICE_PENDING
  INVOICE_APPROVED
  INVOICE_REJECTED
  INVOICE_SENT
  INVOICE_PAID
  INVOICE_OVERDUE
  INVOICE_FOLLOW_UP
  SYSTEM
  SCHEDULE_PENDING
  SCHEDULE_APPROVED
  SCHEDULE_REJECTED
  INVOICE_VOID
}

enum ScheduleStatus {
  ACTIVE
  PAUSED
  ENDED
  PENDING
}

enum RunStatus {
  PENDING
  SUCCESS
  FAILED
  SKIPPED
}

enum HitpayPaymentStatus {
  PENDING
  COMPLETED
  FAILED
}
